<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Business Dashboard â€“ Manage Queues</title>
  <link rel="stylesheet" href="mstyle.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>

  <div class="page-wrapper">

    <h1 class="app-title">Business Dashboard: Manage Queues</h1><br>

    <div class="topnav">

      <div class="nav-left">
        <a href="businessoverview.html">Overview</a>
        <a href="businessQueue.html">Queues</a>
        <a href="businessManage.html" class="active">Manage Queues</a>
        <a href="businessReports.html">Reports/Analytics</a>
      </div>

      <div class="nav-right">
        <div class="account-dropdown">
          <div class="account-icon">ðŸ‘¤</div>
          <div class="account-menu">
            <a href="mainlogin.html">Logout</a>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-container">

      <h2 class="dashboard-title" id="manageTitle">Manage Active Queue</h2>

      <div class="manage-queue-cards">

        <div class="queue-card">
          <div class="queue-card-content">
            <div class="big-plus">+</div>
          </div>
          <a href="Businessaddqueue.html">
            <button class="queue-btn add-btn">Add Queue</button>
          </a>
        </div>

        <div class="queue-card">
          <div class="queue-card-content" id="queueListCard">
            <p>Select a business queue from Overview or Queues pages.</p>
          </div>
          <button class="queue-btn delete-btn" id="deleteQueueBtn">Delete Queue</button>
        </div>

      </div>

      <div class="manage-table-wrapper">
        <table class="manage-table">
          <thead>
            <tr>
              <th>Ticket</th>
              <th>User ID</th>
              <th>Status (local only)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="activeQueueBody">
            <tr>
              <td colspan="4">No one in the queue yet.</td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>

  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  let businessId = params.get("businessId") || null;

  async function loadManagePage() {
    const titleEl = document.getElementById("manageTitle");
    const tbody = document.getElementById("activeQueueBody");

    tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

    try {
      const bizRes = await fetch("http://localhost:3000/businesses");
      const bizData = await resToJsonSafe(bizRes);

      if (!bizData || !bizData.success) {
        tbody.innerHTML = "<tr><td colspan='4'>Could not load businesses.</td></tr>";
        return;
      }

      const businesses = bizData.businesses || [];

      if (!businesses.length) {
        titleEl.textContent = "Manage Active Queue â€“ No businesses found";
        tbody.innerHTML = "<tr><td colspan='4'>No data.</td></tr>";
        return;
      }

      let current = null;

      if (businessId) {
        current = businesses.find(b => String(b.id) === String(businessId));
      }

      if (!current) {
        current = businesses.find(b => Number(b.queue_length) > 0);
      }

      if (!current) {
        current = businesses[0];
      }

      businessId = current.id;
      titleEl.textContent = `Manage Active Queue â€“ ${current.name}`;

      const queueRes = await fetch(`http://localhost:3000/business-queue/${businessId}`);
      const queueData = await resToJsonSafe(queueRes);

      console.log("business-queue response:", queueData);

      if (!queueData || !queueData.success) {
        tbody.innerHTML = "<tr><td colspan='4'>Could not load queue.</td></tr>";
        return;
      }

      const queue = queueData.queue || queueData.customers || [];

      if (!queue.length) {
        tbody.innerHTML = "<tr><td colspan='4'>No one in the queue yet.</td></tr>";
        return;
      }

      tbody.innerHTML = "";

      queue.forEach(entry => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${entry.ticket_number}</td>
          <td>${entry.username || entry.user_id}</td>
          <td>
            <select class="status-select">
              <option>Waiting</option>
              <option>Served</option>
              <option>Skipped</option>
              <option>No Show</option>
            </select>
          </td>
          <td>
            <button class="leave-btn" data-user="${entry.user_id}">
              Remove
            </button>
          </td>
        `;

        tr.querySelector(".status-select").addEventListener("change", () => {
        });

        tr.querySelector(".leave-btn").addEventListener("click", async () => {
          const userId = entry.user_id;
          const confirmLeave = confirm(`Remove user ${entry.username || userId} from this queue?`);
          if (!confirmLeave) return;

          try {
            const res = await fetch("http://localhost:3000/leave-queue", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId: Number(userId) })
            });

            const data = await res.json();

            if (data.success) {
              alert(`Removed user ${entry.username || userId} from the queue.`);
              loadManagePage();
            } else {
              alert(data.message || "Failed to remove user.");
            }
          } catch (err) {
            console.error(err);
            alert("Server error.");
          }
        });

        tbody.appendChild(tr);
      });

    } catch (err) {
      console.error(err);
      document.getElementById("activeQueueBody").innerHTML =
        "<tr><td colspan='4'>Error loading queue.</td></tr>";
    }
  }

  async function resToJsonSafe(res) {
    try {
      return await res.json();
    } catch (e) {
      console.error("Failed to parse JSON:", e);
      return null;
    }
  }

  document.getElementById("deleteQueueBtn").addEventListener("click", async () => {
    if (!businessId) {
        alert("No business selected.");
        return;
    }

    const confirmDelete = confirm(
        "This will delete this entire queue (business) and remove all customers. Continue?"
    );
    if (!confirmDelete) return;

    try {
        const res = await fetch("http://localhost:3000/delete-business", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ businessId })
        });

        const data = await res.json();
        if (!data.success) {
            alert(data.message || "Failed to delete queue.");
            return;
        }

        alert("Queue deleted successfully.");
        window.location.href = "businessQueue.html";
    } catch (err) {
        console.error(err);
        alert("Server error while deleting queue.");
    }
  });

  loadManagePage();
  setInterval(loadManagePage, 3000);
</script>

</body>
</html>
