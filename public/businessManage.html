<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Business Dashboard â€“ Manage Queues</title>
  <link rel="stylesheet" href="mstyle.css">
</head>

<body>

  <div class="page-wrapper">

    <h1 class="app-title">Business Dashboard: Manage Queues</h1><br>

    <!-- TOP NAV -->
    <div class="topnav">

      <!-- LEFT NAV -->
      <div class="nav-left">
        <a href="businessoverview.html">Overview</a>
        <a href="businessQueue.html">Queues</a>
        <a href="businessManage.html" class="active">Manage Queues</a>
        <a href="businessReports.html">Reports/Analytics</a>
      </div>

      <div class="nav-right">
        <div class="account-dropdown">
          <div class="account-icon">ðŸ‘¤</div>
          <div class="account-menu">
            <a href="loginbusiness.html">Logout</a>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="dashboard-container">

      <h2 class="dashboard-title" id="manageTitle">Manage Active Queue</h2>

      <!-- 3 CARD LAYOUT -->
      <div class="manage-queue-cards">

        <!-- ADD QUEUE -->
        <div class="queue-card">
          <div class="queue-card-content">
            <div class="big-plus">+</div>
          </div>
          <a href="Businessaddqueue.html">
            <button class="queue-btn add-btn">Add Queue</button>
          </a>
        </div>

        <!-- LIST OF QUEUES -->
        <div class="queue-card">
          <div class="queue-card-content" id="queueListCard">
            <p>Select a business queue from Overview or Queues pages.</p>
          </div>
          <button class="queue-btn delete-btn" id="deleteQueueBtn">Delete Queue</button>
        </div>

        <!-- EDIT QUEUE -->
        <div class="queue-card">
          <div class="queue-card-content">
            <p>Update queue status for each ticket.</p>
          </div>
          <button class="queue-btn edit-btn" id="editQueueBtn">Edit Queue</button>
        </div>

      </div>

      <!-- ACTIVE QUEUE TABLE -->
      <div class="manage-table-wrapper">
        <table class="manage-table">
          <thead>
            <tr>
              <th>Ticket</th>
              <th>User ID</th>
              <th>Status (local only)</th>
              <th></th>
            </tr>
          </thead>

          <tbody id="activeQueueBody">
            <!-- Filled dynamically -->
          </tbody>
        </table>
      </div>

    </div>

  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    let businessId = params.get("businessId") || null;

    async function loadManagePage() {
      const titleEl = document.getElementById("manageTitle");
      const tbody = document.getElementById("activeQueueBody");

      tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

      try {
        // Load all businesses first to find the one we're managing
        const bizRes = await fetch("http://localhost:3000/businesses");
        const bizData = await bizRes.json();

        if (!bizData.success) {
          tbody.innerHTML = "<tr><td colspan='4'>Could not load businesses.</td></tr>";
          return;
        }

        const businesses = bizData.businesses || [];

        if (!businesses.length) {
          titleEl.textContent = "Manage Active Queue â€“ No businesses found";
          tbody.innerHTML = "<tr><td colspan='4'>No data.</td></tr>";
          return;
        }

        let current = null;
        if (businessId) {
          current = businesses.find(b => String(b.id) === String(businessId));
        }
        if (!current) {
          current = businesses[0];
          businessId = current.id;
        }

        titleEl.textContent = `Manage Active Queue â€“ ${current.name}`;

        // Now load the queue for this business
        const queueRes = await fetch(`http://localhost:3000/business-queue/${businessId}`);
        const queueData = await queueRes.json();

        if (!queueData.success) {
          tbody.innerHTML = "<tr><td colspan='4'>Could not load queue.</td></tr>";
          return;
        }

        const queue = queueData.queue || [];

        if (!queue.length) {
          tbody.innerHTML = "<tr><td colspan='4'>No one in the queue yet.</td></tr>";
          return;
        }

        tbody.innerHTML = "";

        queue.forEach(entry => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${entry.ticket_number}</td>
            <td>${entry.user_id}</td>
            <td>
              <select class="status-select">
                <option>Waiting</option>
                <option>Served</option>
                <option>Skipped</option>
                <option>No Show</option>
              </select>
            </td>
            <td></td>
          `;

          // Currently this status is only local (no backend update)
          tr.querySelector(".status-select").addEventListener("change", () => {
            // You can hook a PUT endpoint here later if you want
          });

          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        document.getElementById("activeQueueBody").innerHTML =
          "<tr><td colspan='4'>Error loading queue.</td></tr>";
      }
    }

    document.getElementById("deleteQueueBtn").addEventListener("click", () => {
      alert("If you want, we can wire this to a DELETE /businesses/:id endpoint.");
    });

    document.getElementById("editQueueBtn").addEventListener("click", () => {
      alert("Right now status changes are local only. Add a backend endpoint to save them if needed.");
    });

    loadManagePage();
  </script>

</body>
</html>
