<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Business Details</title>
    <link rel="stylesheet" href="istyle.css">
</head>

<body>
<div class="page-wrapper">

    <!-- TOP NAV -->
    <div class="topnav">
        <div class="nav-left">
            <a href="customerdashboard.html">Home</a>
            <a href="customerdashboardmyqueue.html">My Queue</a>
            <a href="notificationinbox.html">Notification Inbox</a>
        </div>

        <div class="nav-right">
            <select class="filter-dropdown" id="filterDropdown" disabled>
                <option>Details</option>
            </select>

            <div class="account-icon">
                <a href="customerdashboardmyaccount.html">ðŸ‘¤</a>
            </div>
        </div>
    </div>

    <!-- DETAILS CARD -->
    <div id="container" class="details-card">
        <h2 id="bizName"></h2>
        <p><strong>Category:</strong> <span id="bizCategory"></span></p>
        <p><strong>Location:</strong> <span id="bizLocation"></span></p>
        <p><strong>Description:</strong> <span id="bizDescription"></span></p>
        <p><strong>People in Queue:</strong> <span id="bizQueueLength"></span></p>

        <button id="joinBtn" class="btn">Join Queue</button>
        <button id="leaveBtn" class="btn" style="display:none;">Leave Queue</button>
    </div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const businessId = params.get("id");
const userId = localStorage.getItem("userId");

const joinBtn = document.getElementById("joinBtn");
const leaveBtn = document.getElementById("leaveBtn");

// Load business details
async function loadBusiness() {
    const res = await fetch("http://localhost:3000/businesses");
    const data = await res.json();

    const biz = data.businesses.find(b => b.id == businessId);
    if (!biz) return;

    document.getElementById("bizName").textContent = biz.name;
    document.getElementById("bizCategory").textContent = biz.category;
    document.getElementById("bizLocation").textContent = biz.location;
    document.getElementById("bizDescription").textContent = biz.description;
    document.getElementById("bizQueueLength").textContent = biz.queue_length;

    checkUserQueue();
}

// Check if user already in queue
async function checkUserQueue() {
    const res = await fetch(`http://localhost:3000/user-queue/${userId}`);
    const data = await res.json();

    if (data.success && data.queue) {
        if (String(data.queue.business_id) === String(businessId)) {
            joinBtn.textContent = `Your Ticket: ${data.queue.ticket_number}`;
            joinBtn.disabled = true;
            leaveBtn.style.display = "inline-block";
        }
    }
}

// Join queue
joinBtn.addEventListener("click", async () => {
    if (joinBtn.disabled) return;

    const res = await fetch("http://localhost:3000/join-queue", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, businessId })
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);

    alert("You joined the queue! Ticket #" + data.ticketNumber);
    window.location.reload();
});

// Leave queue
leaveBtn.addEventListener("click", async () => {
    const res = await fetch("http://localhost:3000/leave-queue", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);

    alert("You have left the queue.");
    window.location.reload();
});

loadBusiness();
</script>

</body>
</html>
